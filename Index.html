<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no"/>
<title>WorldGold ‚Äî Tap</title>
<style>
:root{
  --bg1:#6c48ff; --bg2:#1b103a; --ink:#fff; --mut:#c7c4ff;
  --heroSize: clamp(260px, 68vw, 480px);     /* moneda/√°rea principal */
  --coinSize: clamp(220px, 58vw, 420px);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
  background:
    radial-gradient(1200px 600px at 50% -20%, var(--bg1) 10%, transparent 60%),
    radial-gradient(1600px 800px at 50% 120%, #120a2a 10%, var(--bg2) 60%);
}

/* ===== Top bar minimal ===== */
.topbar{
  position:sticky; top:0; z-index:5;
  display:flex; align-items:center; justify-content:center;
  padding: max(10px, env(safe-area-inset-top)) 12px 8px;
  background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
  backdrop-filter: blur(4px);
}
.topbar h1{margin:0;font-size:28px;letter-spacing:.3px}
.top-actions{
  position:absolute; right:12px; top:calc(8px + env(safe-area-inset-top));
  font-size:12px; color:var(--mut); text-align:right;
}
.floatCol{
  position:fixed; left:12px; top:calc(12px + env(safe-area-inset-top)); z-index:6;
  display:flex; flex-direction:column; gap:10px;
}
.fab{width:48px;height:48px;border:none;border-radius:50%;display:grid;place-items:center;
  color:#fff; box-shadow:0 10px 24px rgba(0,0,0,.35); cursor:pointer}
.fab.profile{background:#06d6a0;color:#08251b}
.fab.trophy{background:#ffd166;color:#2b2005}
.fab.inbox{background:#7c5cff}
.badge{position:absolute;top:-6px;right:-6px;background:#ff3b3b;color:#fff;border-radius:999px;min-width:18px;height:18px;
  display:grid;place-items:center;font-size:11px;font-weight:700;padding:0 6px}

/* ===== HERO full-screen (mobile-first) ===== */
.hero{
  min-height: calc(100dvh - 76px - env(safe-area-inset-bottom));
  display:grid; place-items:center; gap:12px;
  padding: 6px 14px calc(20px + env(safe-area-inset-bottom));
}
.pill{
  background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.18);
  border-radius:999px; padding:6px 14px; font-weight:700; font-size:16px;
  display:inline-flex; align-items:center; gap:8px; backdrop-filter:blur(4px)
}
.pill .ico{font-size:18px}

/* Moneda sin ‚Äúcaja‚Äù */
.coinWrap{
  position:relative; width:var(--heroSize); height:var(--heroSize); border-radius:999px;
  display:grid; place-items:center;
  background: radial-gradient(60% 60% at 50% 40%, #352b74, #1a1340 70%);
  box-shadow: 0 40px 120px rgba(0,0,0,.35) inset, 0 10px 40px rgba(0,0,0,.25);
}
.coin{
  width:var(--coinSize); height:var(--coinSize); border-radius:999px;
  display:grid; place-items:center; user-select:none; touch-action:manipulation;
  background:linear-gradient(145deg,#2a2555,#1c143f);
  border:1px solid rgba(255,255,255,.12);
  transition:transform .08s ease;
}
.coin:active{transform:scale(.98)}
.coinEmoji{font-size:52px}
.gain{position:absolute;left:50%;top:42%;transform:translate(-50%,-50%);
  font-weight:900; font-size:20px; opacity:0; pointer-events:none}
.gain.show{animation:float .6s ease-out forwards}
@keyframes float{
  from{opacity:0;transform:translate(-50%,-10px) scale(.9)}
  50%{opacity:1}
  to{opacity:0;transform:translate(-50%,-40px) scale(1.05)}
}

/* Autotap status dot */
.autoDot{position:absolute;top:12px;right:12px;width:12px;height:12px;border-radius:50%;
  background:#666;border:2px solid rgba(255,255,255,.6)}
.autoDot.blink{animation:blink 1s linear infinite}
@keyframes blink{0%,49%{background:#e03030}50%,100%{background:#992020}}

/* Refill a la izquierda + precio bajo (sutil) */
.refill{
  position:absolute; left:6px; top:50%; transform:translateY(-50%);
  width:42px;height:42px;border-radius:50%; border:1px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.35); display:grid; place-items:center; cursor:pointer
}
.refill.pulse{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:translateY(-50%) scale(1)}50%{transform:translateY(-50%) scale(1.08)}}
.refillPrice{position:absolute; left:6px; top:calc(50% + 34px); transform:translateY(-50%);
  font-size:11px;color:var(--mut); background:rgba(0,0,0,.4); border:1px solid rgba(255,255,255,.18);
  border-radius:8px; padding:2px 6px}

/* Engrane a la derecha */
.gear{
  position:absolute; right:6px; top:50%; transform:translateY(-50%);
  width:42px;height:42px;border-radius:50%; border:none; background:#7c5cff; color:#fff; cursor:pointer
}

/* Energ√≠a debajo, integrada */
.energyWrap{width:min(92%, 520px); text-align:center}
.energyBar{height:16px;background:#231b68;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
.energyFill{height:100%;background:linear-gradient(90deg,#7c5cff,#bdb3ff);background-size:200% 100%;animation:shimmer 3s linear infinite}
@keyframes shimmer{0%{background-position:0 0}100%{background-position:200% 0}}
.energyLbl{margin-top:6px;font-size:13px;color:var(--mut)}

/* Drawers gen√©ricos */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:50}
.backdrop.show{opacity:1;pointer-events:auto}
.drawer{position:fixed;top:0;right:-380px;width:min(360px,92vw);height:100dvh;background:rgba(10,8,24,.98);
  border-left:1px solid rgba(255,255,255,.1);padding:16px 16px calc(24px + env(safe-area-inset-bottom));transition:right .28s ease;overflow:auto;z-index:55}
.drawer.show{right:0}
.drawer .close{position:sticky;top:0;margin-left:auto;width:34px;height:34px;border-radius:50%;
  border:1px solid rgba(255,255,255,.25);background:transparent;color:#fff;cursor:pointer;font-size:18px}

/* Panel Boosters (lateral) */
.upBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:.2s;z-index:54}
.upBackdrop.show{opacity:1;pointer-events:auto}
.upMini{position:fixed;right:-340px;top:70px;width:min(320px,90vw);background:rgba(10,8,24,.98);
  border-left:1px solid rgba(255,255,255,.12);border-top-left-radius:12px;border-bottom-left-radius:12px;
  box-shadow:-10px 0 30px rgba(0,0,0,.35);transition:right .28s ease;z-index:56}
.upMini.show{right:0}
.upItem{border-bottom:1px dashed rgba(255,255,255,.12);padding:10px 12px}
.upItem:last-child{border-bottom:none}
.cta{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;background:#7c5cff;color:#fff;font-weight:700}
.ghost{background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
.price{font-size:12px;color:var(--mut)}

/* Demo tools (se ocultan en m√≥vil si quieres) */
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;margin:12px}
@media (max-width:560px){ .card{display:none} } /* oculta panel demo en m√≥viles */
</style>
</head>
<body>

<!-- Columna de iconos (izquierda) -->
<div class="floatCol">
  <button id="profileBtn" class="fab profile" title="Perfil">üë§</button>
  <button id="trophyBtn" class="fab trophy" title="Leaderboard">üèÜ</button>
  <button id="inboxBtn" class="fab inbox" title="Inbox">‚úâÔ∏è <span id="inboxBadge" class="badge" style="display:none">0</span></button>
</div>

<!-- Topbar -->
<div class="topbar">
  <h1>WorldGold</h1>
  <div class="top-actions">
    <div style="font-size:12px">WLD Balance:</div>
    <div><b id="balWLD">0.00</b> WLD</div>
  </div>
</div>

<!-- HERO -->
<section class="hero">
  <div class="pill"><span class="ico">ü™ô</span> WLGp: <b id="balWLGp">0.000</b></div>

  <div class="coinWrap" id="coinBox">
    <div id="autoDot" class="autoDot" title="Autotap"></div>

    <button id="refillBtn" class="refill" title="Refill">‚ö°</button>
    <div id="refillPrice" class="refillPrice">0.10 WLD</div>

    <div id="coin" class="coin" aria-label="Tap">
      <div class="coinEmoji">ü™ô</div>
      <div id="gain" class="gain">+0.40</div>
    </div>

    <button id="openUp" class="gear" aria-label="Boosters">‚öôÔ∏è</button>
  </div>

  <div class="energyWrap">
    <div class="energyBar"><div id="energyFill" class="energyFill" style="width:100%"></div></div>
    <div class="energyLbl">‚ö° <b id="energyNow">100</b>/<b id="energyMax">100</b></div>
  </div>
</section>

<!-- Herramientas demo (ocultables en m√≥vil) -->
<section class="card">
  <h3 style="margin:0 0 8px">Herramientas de prueba (demo)</h3>
  <div style="display:flex;gap:10px;justify-content:flex-end">
    <button id="btnAddWLD" class="ghost">+5 WLD</button>
    <button id="btnReset" class="ghost">Reset</button>
  </div>
</section>

<!-- Drawers -->
<div id="backdropIN" class="backdrop"></div>
<aside id="drawerIN" class="drawer" aria-modal="true" role="dialog">
  <button class="close" data-close="IN" aria-label="Cerrar">√ó</button>
  <h3 style="margin:0 0 8px">Inbox</h3>
  <div id="msgList"></div>
</aside>

<div id="backdropCS" class="backdrop"></div>
<aside id="drawerCS" class="drawer" aria-modal="true" role="dialog">
  <button class="close" data-close="CS" aria-label="Cerrar">√ó</button>
  <h3 style="margin:0 0 8px">Pr√≥ximamente</h3>
  <p style="opacity:.8">Leaderboard, Full Pass y Claim WLD estar√°n disponibles pronto.</p>
</aside>

<div id="backdropPR" class="backdrop"></div>
<aside id="drawerPR" class="drawer" aria-modal="true" role="dialog">
  <button class="close" data-close="PR" aria-label="Cerrar">√ó</button>
  <h3 style="margin:0 0 8px">Perfil</h3>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
    <input id="nick2" placeholder="@your-nick" maxlength="20" style="flex:1;border:1px solid rgba(255,255,255,.25);border-radius:10px;background:transparent;color:#fff;padding:6px 10px">
    <button id="saveNick2" class="ghost">Guardar</button>
    <select id="langSel" style="width:150px;border:1px solid rgba(255,255,255,.25);border-radius:10px;background:transparent;color:#fff;padding:6px 10px">
      <option value="en" selected>English</option>
      <option value="es">Espa√±ol</option>
    </select>
  </div>
  <div style="display:grid;gap:8px">
    <div style="display:flex;justify-content:space-between"><span>Usuario</span><b id="profUser">@YOU</b></div>
    <div style="display:flex;justify-content:space-between"><span>WLGp</span><b id="profWLGp">0</b></div>
    <div style="display:flex;justify-content:space-between"><span>WLD</span><b id="profWLD">0.00</b></div>
  </div>
</aside>

<!-- Boosters panel -->
<div id="upBackdrop" class="upBackdrop"></div>
<aside id="upMini" class="upMini" aria-label="Boosters">
  <div class="upItem">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div><b>Power +0.01</b><div class="price">Actual: <b id="lvlPower">0.40</b> WLGp/tap</div></div>
      <div style="text-align:right"><div class="price">Precio: <b id="pricePower">0.1</b> WLD</div><button id="buyPower" class="cta" style="margin-top:6px">Mejorar</button></div>
    </div>
    <div class="price" style="margin-top:6px">Tramos: 0.40‚Äì0.49 ‚Üí 0.1; 0.50‚Äì0.59 ‚Üí 0.2; 0.60‚Äì0.69 ‚Üí 0.3‚Ä¶</div>
  </div>
  <div class="upItem">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div><b>Battery +50</b><div class="price">Actual: <b id="lvlCap">100</b> taps</div></div>
      <div style="text-align:right"><div class="price">Precio: <b id="priceCap">0.1</b> WLD</div><button id="buyCap" class="cta" style="margin-top:6px">Mejorar</button></div>
    </div>
  </div>
  <div class="upItem">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div><b>Speed +15%</b><div class="price">Actual: <b id="lvlRegen">+0%</b> ¬∑ Recarga: <b id="regenRate">0</b>/min</div></div>
      <div style="text-align:right"><div class="price">Precio: <b id="priceRegen">0.1</b> WLD</div><button id="buyRegen" class="cta" style="margin-top:6px">Mejorar</button></div>
    </div>
  </div>
  <div class="upItem">
    <div><b>Autotap</b><div class="price">3h consumible. 6h/8h/24h: pago √∫nico, reactivables y acumulables.</div></div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px">
      <button class="ghost" data-auto="3">3h ‚Äî 3</button>
      <button class="ghost" data-auto="6">6h ‚Äî 5</button>
      <button class="ghost" data-auto="8">8h ‚Äî 7</button>
      <button class="ghost" data-auto="24">24h ‚Äî 20</button>
    </div>
    <div class="price" style="margin-top:6px">Estado: <b id="autoState">Off</b> ¬∑ Queda: <b id="autoRemain">‚Äî</b></div>
    <div class="price" id="autoUnlocks" style="margin-top:4px"></div>
    <div style="text-align:center;margin-top:8px"><button id="btnReactivate" class="ghost" style="display:none">Reactivar sesi√≥n</button></div>
  </div>
  <div class="upItem" style="text-align:center"><button id="closeUp" class="ghost">Cerrar</button></div>
</aside>

<script>
/* ===== Helpers ===== */
const $=q=>document.querySelector(q), $$=q=>[...document.querySelectorAll(q)];
let AC; function tone(f=560,d=.05,t='triangle',v=.08){try{AC=AC||new (window.AudioContext||window.webkitAudioContext)();const o=AC.createOscillator(),g=AC.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g).connect(AC.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+d);o.stop(AC.currentTime+d+0.02);}catch(e){}}
function fmt(ms){const s=Math.max(0,Math.floor(ms/1e3)),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return h?`${h}h ${m}m ${sec}s`:`${m}m ${sec}s`}

/* ===== Config ===== */
const BASE_CAP=100;               // inicia 100 (mobile-friendly)
const BASE_REGEN_PER_SEC=0.8;     // ~48/min (un poco m√°s r√°pido)
const REGEN_STEP=0.15;            // +15% por compra
const POWER_BASE=0.40;            // WLGp/tap
const POWER_STEP=0.01;
const CAP_STEP=50;                // +50 por compra
const AUTOBOT_RATE_TPS=1.4;       // un poco m√°s lento que el mano

/* ===== Estado ===== */
let wlgp= +localStorage.getItem('wlg_points') ||0;
let wld = +localStorage.getItem('wlg_wld')     ||0;
let energy=+localStorage.getItem('wlg_energy'); if(isNaN(energy)) energy=BASE_CAP;
let lastTs=+localStorage.getItem('wlg_last_ts')||Date.now();
let powerBuys=+localStorage.getItem('wlg_power_buys')||0;
let capBuys  =+localStorage.getItem('wlg_cap_buys')  ||0;
let regenBuys=+localStorage.getItem('wlg_regen_buys')||0;

/* Autotap */
let autoUntil=+localStorage.getItem('wlg_auto_until')||0;
let autoUnlock6=!!JSON.parse(localStorage.getItem('wlg_auto_u6')||'false');
let autoUnlock8=!!JSON.parse(localStorage.getItem('wlg_auto_u8')||'false');
let autoUnlock24=!!JSON.parse(localStorage.getItem('wlg_auto_u24')||'false');
let autoPaused50=false;

/* Inbox demo */
let inbox=JSON.parse(localStorage.getItem('wlg_inbox')||'[]');
if(inbox.length===0){
  inbox=[{id:1,title:'Bienvenido',body:'Toca la moneda para ganar WLGp. Abre ‚öôÔ∏è para mejoras y Autotap.',unread:true,ts:Date.now()}];
  localStorage.setItem('wlg_inbox',JSON.stringify(inbox));
}

/* ===== Derivados ===== */
function power(){return +(POWER_BASE + POWER_STEP*powerBuys).toFixed(2)}
function capMax(){return BASE_CAP + capBuys*CAP_STEP}
function regenPerSec(){return BASE_REGEN_PER_SEC * (1 + regenBuys*REGEN_STEP)}
function pricePower(){ const p=power(); const tier=Math.max(0,Math.floor((p-0.40+1e-9)/0.10)); return +(0.1*(tier+1)).toFixed(1); }
function priceCap(){   return +(0.1*(capBuys+1)).toFixed(1) }
function priceRegen(){ return +(0.1*(regenBuys+1)).toFixed(1) }
function refillCost(){ return +(capMax()/1000).toFixed(2) }     // 0.1% de capacidad

/* ===== Refs ===== */
const balWLD=$('#balWLD'), balWLGp=$('#balWLGp');
const coin=$('#coin'), gain=$('#gain'), autoDot=$('#autoDot');
const energyFill=$('#energyFill'), energyNow=$('#energyNow'), energyMax=$('#energyMax');
const refillBtn=$('#refillBtn'), refillPrice=$('#refillPrice');
const openUp=$('#openUp'), upMini=$('#upMini'), upBackdrop=$('#upBackdrop'), closeUp=$('#closeUp');
const lvlPower=$('#lvlPower'), lvlCap=$('#lvlCap'), lvlRegen=$('#lvlRegen'), regenRate=$('#regenRate');
const pricePowerEl=$('#pricePower'), priceCapEl=$('#priceCap'), priceRegenEl=$('#priceRegen');
const buyPower=$('#buyPower'), buyCap=$('#buyCap'), buyRegen=$('#buyRegen');
const autoState=$('#autoState'), autoRemain=$('#autoRemain'), autoUnlocks=$('#autoUnlocks'), btnReactivate=$('#btnReactivate');
const inboxBtn=$('#inboxBtn'), inboxBadge=$('#inboxBadge'), drawerIN=$('#drawerIN'), backdropIN=$('#backdropIN'), msgList=$('#msgList');
const trophyBtn=$('#trophyBtn'), drawerCS=$('#drawerCS'), backdropCS=$('#backdropCS');
const profileBtn=$('#profileBtn'), drawerPR=$('#drawerPR'), backdropPR=$('#backdropPR');
const nick2=$('#nick2'), saveNick2=$('#saveNick2'), langSel=$('#langSel');
const profUser=$('#profUser'), profWLGp=$('#profWLGp'), profWLD=$('#profWLD');
const btnAddWLD=$('#btnAddWLD'), btnReset=$('#btnReset');

/* ===== L√≥gica ===== */
function lazyRegen(){
  const now=Date.now(), dt=(now-lastTs)/1000; lastTs=now;
  energy=Math.min(capMax(), energy + regenPerSec()*dt);
  localStorage.setItem('wlg_last_ts',String(lastTs));
  localStorage.setItem('wlg_energy',String(energy));
}
function render(){
  balWLD.textContent=wld.toFixed(2);
  balWLGp.textContent=wlgp.toFixed(3);

  const eMax=capMax(); const pct=Math.max(0,Math.min(100,(energy/eMax)*100));
  energyFill.style.width=pct.toFixed(1)+'%';
  energyNow.textContent=Math.floor(energy); energyMax.textContent=eMax;
  refillPrice.textContent = refillCost().toFixed(2)+' WLD';
  refillBtn.classList.toggle('pulse', pct<25);
  refillBtn.disabled = (wld<refillCost() || energy>=eMax-1e-6);

  // boosters
  lvlPower.textContent=power().toFixed(2);
  lvlCap.textContent=eMax;
  const regenPerc=Math.round(regenBuys*REGEN_STEP*100);
  lvlRegen.textContent='+'+regenPerc+'%';
  regenRate.textContent=(regenPerSec()*60).toFixed(1);
  pricePowerEl.textContent=pricePower().toFixed(1);
  priceCapEl.textContent=priceCap().toFixed(1);
  priceRegenEl.textContent=priceRegen().toFixed(1);
  buyPower.disabled=wld<pricePower();
  buyCap.disabled  =wld<priceCap();
  buyRegen.disabled=wld<priceRegen();

  // autotap
  const active=Date.now()<autoUntil;
  autoDot.classList.toggle('blink',active);
  autoState.textContent=active?'ON':'Off';
  autoRemain.textContent=active?fmt(autoUntil-Date.now()):'‚Äî';
  const unlockedTxt = ['6h','8h','24h'].filter((h,i)=>[autoUnlock6,autoUnlock8,autoUnlock24][i]).join(' + ');
  autoUnlocks.textContent = unlockedTxt?('Desbloqueado: '+unlockedTxt):'';
  btnReactivate.style.display = (!active && (autoUnlock6||autoUnlock8||autoUnlock24))?'inline-block':'none';

  // perfil
  profWLGp.textContent=wlgp.toFixed(3); profWLD.textContent=wld.toFixed(2);
}
function addTap(n=1){
  const doable=Math.min(Math.floor(energy), n);
  if(doable<=0) return 0;
  energy-=doable;
  const gainPoints = power()*doable; // solo WLGp
  wlgp += gainPoints;
  localStorage.setItem('wlg_points',String(wlgp));
  return gainPoints;
}
function popGain(txt){ gain.textContent=txt; gain.classList.remove('show'); void gain.offsetWidth; gain.classList.add('show'); }

/* ===== Eventos ===== */
coin.addEventListener('click',()=>{
  lazyRegen();
  const g=addTap(1);
  if(g>0){ popGain(`+${g.toFixed(2)}`); tone(780,0.05,'triangle',.07); coin.style.transform='scale(1.06)'; setTimeout(()=>{coin.style.transform='scale(1)'},120); }
  render();
});

/* Boosters open/close */
openUp.onclick=()=>{ upMini.classList.add('show'); upBackdrop.classList.add('show'); }
closeUp.onclick=()=>{ upMini.classList.remove('show'); upBackdrop.classList.remove('show'); }
upBackdrop.onclick=()=>{ closeUp.click(); }

/* Compras */
buyPower.onclick=()=>{const p=pricePower(); if(wld<p)return; wld-=p; powerBuys++; localStorage.setItem('wlg_wld',String(wld)); localStorage.setItem('wlg_power_buys',String(powerBuys)); render();}
buyCap.onclick  =()=>{const p=priceCap();   if(wld<p)return; wld-=p; capBuys++; energy=Math.min(capMax(),energy); localStorage.setItem('wlg_wld',String(wld)); localStorage.setItem('wlg_cap_buys',String(capBuys)); render();}
buyRegen.onclick=()=>{const p=priceRegen(); if(wld<p)return; wld-=p; regenBuys++; localStorage.setItem('wlg_wld',String(wld)); localStorage.setItem('wlg_regen_buys',String(regenBuys)); render();}
function doRefill(){ const cost=refillCost(); if(wld<cost)return; const eMax=capMax(); if(energy>=eMax-1e-6)return; wld-=cost; localStorage.setItem('wlg_wld',String(wld)); energy=eMax; render(); }
refillBtn.onclick=doRefill;

/* Autotap compras y reactivaci√≥n */
$$('.upItem button.ghost[data-auto]').forEach(b=>b.onclick=()=>{
  const hours=+b.dataset.auto;
  const price = (hours===3?3:hours===6?5:hours===8?7:hours===24?20:999);
  if(hours===3){
    if(wld<price){alert('Saldo WLD insuficiente');return;}
    wld-=price; localStorage.setItem('wlg_wld',String(wld));
    const now=Date.now(); autoUntil=Math.max(autoUntil,now)+hours*3600*1000; localStorage.setItem('wlg_auto_until',String(autoUntil));
  }else{
    if((hours===6&&autoUnlock6)||(hours===8&&autoUnlock8)||(hours===24&&autoUnlock24)){ alert('Ya comprado'); return; }
    if(wld<price){alert('Saldo WLD insuficiente');return;}
    wld-=price; localStorage.setItem('wlg_wld',String(wld));
    if(hours===6){autoUnlock6=true; localStorage.setItem('wlg_auto_u6','true')}
    if(hours===8){autoUnlock8=true; localStorage.setItem('wlg_auto_u8','true')}
    if(hours===24){autoUnlock24=true; localStorage.setItem('wlg_auto_u24','true')}
  }
  render();
});
btnReactivate.onclick=()=>{ const sum=(autoUnlock6?6:0)+(autoUnlock8?8:0)+(autoUnlock24?24:0); if(sum<=0) return; autoPaused50=false; autoUntil=Date.now()+sum*3600*1000; localStorage.setItem('wlg_auto_until',String(autoUntil)); render();}

/* Loop: recarga + autobot (pausa <50%) */
setInterval(()=>{
  lazyRegen();
  const now=Date.now(); const active=now<autoUntil;
  if(active){
    const eMax=capMax(); const pct=energy/eMax;
    if(autoPaused50){ if(pct>=0.5){ autoPaused50=false; } }
    else{ if(energy<1){ autoPaused50=true; } }
    if(!autoPaused50){
      const perTick = AUTOBOT_RATE_TPS/5;
      const taps = Math.max(1, Math.floor(perTick));
      const g=addTap(taps);
      if(g>0) tone(560,0.02,'square',.03);
    }
  }
  render();
},200);

/* Inbox & Drawers */
function openDrawer(el,b){ el.classList.add('show'); b.classList.add('show'); }
function closeDrawer(el,b){ el.classList.remove('show'); b.classList.remove('show'); }
inboxBtn.onclick=()=>{ const list=$('#msgList'); list.innerHTML=''; inbox.forEach(m=>{const div=document.createElement('div'); div.style.cssText='border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;margin:10px 0;background:rgba(0,0,0,.25)'; const dt=new Date(m.ts).toLocaleString(); div.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px"><b>${m.title}</b><span style="opacity:.7">${dt}</span></div><div style="opacity:.85;margin-top:4px">${m.body}</div>`; list.appendChild(div);}); openDrawer(drawerIN,backdropIN); inbox=inbox.map(m=>({...m,unread:false})); localStorage.setItem('wlg_inbox',JSON.stringify(inbox)); const unread=inbox.filter(m=>m.unread).length; inboxBadge.style.display=unread?'grid':'none'; inboxBadge.textContent=unread||'0'; }
backdropIN.onclick=()=>closeDrawer(drawerIN,backdropIN); drawerIN.querySelector('.close').onclick=()=>closeDrawer(drawerIN,backdropIN);
trophyBtn.onclick=()=>openDrawer(drawerCS,backdropCS);
backdropCS.onclick=()=>closeDrawer(drawerCS,backdropCS); drawerCS.querySelector('.close').onclick=()=>closeDrawer(drawerCS,backdropCS);

/* Perfil + idioma */
profileBtn.onclick=()=>openDrawer(drawerPR,backdropPR);
backdropPR.onclick=()=>closeDrawer(drawerPR,backdropPR); drawerPR.querySelector('.close').onclick=()=>closeDrawer(drawerPR,backdropPR);
saveNick2.onclick=()=>{let v=(nick2.value||'').trim(); v=v?(v.startsWith('@')?v:'@'+v):'@YOU'; localStorage.setItem('wlg_nick',v); profUser.textContent=v;}
langSel.value = localStorage.getItem('wlg_lang') || 'en';
langSel.onchange=()=>{ localStorage.setItem('wlg_lang', langSel.value); alert('Idioma guardado (demo)'); }

/* Demo */
btnAddWLD.onclick=()=>{wld+=5; localStorage.setItem('wlg_wld',String(wld)); render();}
btnReset.onclick =()=>{ if(confirm('¬øReiniciar todo?')){ localStorage.clear(); location.reload(); } }

/* Init */
(function init(){
  const nick=localStorage.getItem('wlg_nick')||'@YOU'; profUser.textContent=nick; nick2.value=nick;
  energy=Math.min(capMax(),energy);
  setInterval(()=>{lazyRegen(); render();},1000);
  render();
})();
</script>
</body>
</html>

